# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a website cloning tool that replicates the Lenovo marketplace homepage (https://marketplace.naea1.uds.lenovo.com/) as a static local build using Firecrawl and Playwright. The goal is pixel-perfect reproduction at 1440×900 with DPR=2, with all assets (CSS, images, fonts) stored locally.

## Key Commands

### Development Pipeline
```bash
# Full pipeline: crawl → capture → rewrite
npm run pipeline

# Individual steps
npm run crawl      # Fetch homepage HTML and discover assets via Firecrawl
npm run capture    # Use Playwright to capture rendered page and assets at DPR=2
npm run rewrite    # Build static Vite app with local assets

# Verification
npm run verify     # Screenshot and compare live vs local renders

# Development server
npm run dev        # Start Vite dev server (default: http://localhost:5173)
npm run build      # Production build
npm run preview    # Preview production build
```

## Architecture

### Three-Stage Pipeline

**1. Crawl (scripts/crawl.mjs)**
- Uses node-fetch to download homepage HTML (Firecrawl integration available via MCP)
- Discovers first-depth, same-origin static assets (CSS, images, fonts) using regex patterns
- Resolves relative URLs and filters to same-origin only
- Outputs:
  - `raw/index.remote.html` - Original HTML
  - `raw/assets.json` - Asset inventory in original order

**2. Capture (scripts/capture.mjs)**
- Launches Playwright/Chromium with viewport 1440×900, DPR=2
- Intercepts network requests to save asset responses
- Preserves runtime-injected styles and DOM changes
- Extracts computed font information from rendered elements
- Outputs:
  - `raw/index.rendered.html` - Rendered HTML snapshot
  - `public/assets/**` - Downloaded assets (css/, fonts/, images/)
  - `verification/live-1440.png` - Screenshot of live page
  - `raw/asset-mapping.json` - URL-to-local-path mappings
  - `raw/font-info.json` - Computed font information

**3. Rewrite (scripts/rewrite.mjs)**
- Builds static Vite app from rendered HTML
- Consolidates all CSS (external + inline) into `public/assets/css/site.css` preserving original order
- Generates @font-face rules for local fonts based on file analysis
- Rewrites asset URLs to point to `/assets/**`
- Removes all external scripts (analytics, tracking, runtime JS)
- Creates `app/index.html`

**4. Verify (scripts/verify.mjs)**
- Spawns local Vite dev server on port 5173
- Screenshots local build at same viewport/DPR
- Automatically stops dev server after screenshot
- Outputs `verification/local-1440.png` for visual comparison

### Directory Structure

```
/app/                   # Vite application (generated by rewrite step)
  index.html            # Main HTML file with rewritten asset paths

/public/assets/         # All local static assets
  css/                  # Stylesheets (consolidated)
    site.css            # All CSS consolidated in original order
  fonts/                # Font files (WOFF/WOFF2)
  images/               # Images

/raw/                   # Intermediate build artifacts
  index.remote.html     # Original fetched HTML
  index.rendered.html   # Playwright-rendered HTML
  assets.json           # Asset inventory from crawl
  asset-mapping.json    # URL-to-local-path mappings
  font-info.json        # Computed font information

/scripts/               # Pipeline scripts (fully implemented)
  crawl.mjs             # Fetch HTML and discover assets
  capture.mjs           # Playwright capture with network interception
  rewrite.mjs           # Generate static Vite app
  verify.mjs            # Screenshot and compare

/verification/          # Visual comparison screenshots
  live-1440.png         # Screenshot of live site
  local-1440.png        # Screenshot of local build

/firecrawl-mcp-server/  # Firecrawl MCP integration (separate module)
```

## Important Constraints

### Asset Handling
- **CSS Order**: Must preserve original `<link>` and `<style>` order from source page
- **Fonts**: Include all weights/styles actually used; generate proper @font-face rules
- **Images**: Keep original formats and srcset/sizes attributes
- **No Hotlinks**: All assets must be local; no external URLs in final build

### Rendering Fidelity
- Target viewport: 1440×900 with deviceScaleFactor=2
- Disable animations during screenshot capture for stable comparisons
- Exclude analytics, A/B testing, consent managers, and other non-rendering scripts
- Preserve inline `<style>` blocks as captured during render

### Scope Limitations
- Respect robots.txt
- Single homepage only + directly referenced same-origin assets
- No authenticated or user-specific paths
- No deep crawling beyond first-depth asset discovery

## Firecrawl MCP Server

The `/firecrawl-mcp-server/` subdirectory contains a Model Context Protocol server for Firecrawl integration. This is a separate npm package with its own build system.

**MCP Server Commands** (within firecrawl-mcp-server/):
```bash
npm install    # Install MCP server dependencies
npm run build  # Build MCP server
npm test       # Run MCP server tests
```

**Environment Variables**:
- `FIRECRAWL_API_KEY` - Required for Firecrawl cloud API
- See firecrawl-mcp-server/README.md for full configuration options

## Vite Configuration

The project uses Vite with custom configuration ([vite.config.js](vite.config.js)):

- **Root**: `app/` directory (where index.html is generated)
- **Public Directory**: `public/` (contains assets)
- **Dev Server**: Port 5173, strict port mode
- **Build Output**: `dist/` directory

## Debugging Layout Differences

When comparing live vs. local screenshots:

1. **CSS Issues**:
   - Check CSS concatenation order in `public/assets/css/site.css`
   - Verify all inline `<style>` blocks were included
   - Look for CSS specificity conflicts

2. **Font Issues**:
   - Compare font-family declarations between live and local
   - Check @font-face rules in consolidated CSS
   - Verify font files exist in `public/assets/fonts/`
   - Inspect `raw/font-info.json` for computed font information

3. **Image Issues**:
   - Verify images downloaded correctly
   - Check srcset/sizes attributes preserved
   - Ensure image URLs rewritten to `/assets/images/**`

4. **DOM Structure**:
   - Compare `raw/index.remote.html` vs `raw/index.rendered.html`
   - Look for runtime-injected elements
   - Check if any JavaScript-dependent layouts were removed

## Current State

The project is **fully implemented and functional**. All pipeline scripts have been completed, tested, and successfully executed. The pipeline can be run end-to-end using `npm run pipeline`, followed by `npm run verify` for visual comparison.

### Implementation Summary

All four pipeline scripts are complete:

**crawl.mjs**:

- Uses node-fetch to download HTML (with fallback to Firecrawl MCP if needed)
- Extracts asset URLs using regex patterns for CSS, images, fonts, and scripts
- Resolves relative URLs to absolute URLs
- Filters to same-origin assets only
- Deduplicates discovered assets
- Outputs `raw/index.remote.html` and `raw/assets.json`

**capture.mjs**:

- Launches headless Chromium via Playwright
- Configures viewport 1440×900 with deviceScaleFactor=2
- Intercepts all network responses to save CSS, fonts, and images
- Organizes assets into subdirectories (css/, fonts/, images/)
- Captures rendered HTML after JavaScript execution
- Extracts computed font information (family, weight, style) from all elements
- Takes full-page screenshot with animations disabled
- Outputs `raw/index.rendered.html`, `public/assets/**`, `verification/live-1440.png`, `raw/asset-mapping.json`, and `raw/font-info.json`

**rewrite.mjs**:

- Reads rendered HTML and asset mappings
- Extracts external stylesheets and inline `<style>` blocks in order
- Generates @font-face rules by analyzing font files in `public/assets/fonts/`
- Consolidates all CSS into single `public/assets/css/site.css`
- Rewrites all asset URLs to local `/assets/**` paths
- Removes all `<script>` tags (external and inline analytics/tracking)
- Outputs `app/index.html` ready for Vite

**verify.mjs**:

- Spawns Vite dev server on port 5173 using `npm run dev`
- Waits for server to be ready (checks stdout for readiness signals)
- Launches Playwright to screenshot local build
- Uses same viewport/DPR settings as capture step
- Disables animations for consistent comparison
- Outputs `verification/local-1440.png`
- Automatically kills dev server after screenshot
- Provides comparison guidance
